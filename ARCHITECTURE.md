# ๐๏ธ Arquitectura de UnifyVision

## ๐ Diagrama de Arquitectura

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           main.py                                โ
โ                    (Punto de Entrada)                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         src/config.py                            โ
โ                  (Configuraciรณn Centralizada)                    โ
โ  โข OPENAI_API_KEY                                               โ
โ  โข GRID_COLS / GRID_ROWS                                        โ
โ  โข Timeouts, delays, etc.                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      Capa de Planificaciรณn                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโ              โ
โ  โ  src/planner.py  โโโโโโโโโโถโ OpenAI Client   โ              โ
โ  โ  โข Planner       โ         โ (Chat API)      โ              โ
โ  โ  โข ActionPlan    โ         โโโโโโโโโโโโโโโโโโโ              โ
โ  โโโโโโโโโโโโโโโโโโโโ                                           โ
โ         โ                                                        โ
โ         โ Genera                                                โ
โ         โผ                                                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                      โ
โ  โ Plan JSON Validado                   โ                      โ
โ  โ [                                    โ                      โ
โ  โ   {"action": "click", "target": ...} โ                      โ
โ  โ   {"action": "type", "text": ...}    โ                      โ
โ  โ ]                                    โ                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โ Plan
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      Capa de Ejecuciรณn                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโ                                           โ
โ  โ src/executor.py  โ                                           โ
โ  โ  โข PlanExecutor  โ                                           โ
โ  โโโโโโโโโโฌโโโโโโโโโโ                                           โ
โ           โ                                                      โ
โ           โ Para cada paso                                      โ
โ           โผ                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโ                                           โ
โ  โ src/actions.py   โ                                           โ
โ  โ โข ActionExecutor โ                                           โ
โ  โ   โโ execute_click()                                        โ
โ  โ   โโ execute_type()                                         โ
โ  โ   โโ execute_press()                                        โ
โ  โ   โโ execute_wait()                                         โ
โ  โโโโโโโโโโฌโโโโโโโโโโ                                           โ
โโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
            โ Para acciones click
            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Capa de Visiรณn (Click)                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโโโ                                         โ
โ  โ screen_capture.py  โ                                         โ
โ  โ โข ScreenCapture    โ                                         โ
โ  โ   โโ capture_screen()                                       โ
โ  โ   โโ get_display_scale()                                    โ
โ  โ   โโ encode_to_base64()                                     โ
โ  โโโโโโโโโโฌโโโโโโโโโโโโ                                         โ
โ           โ                                                      โ
โ           โ Imagen                                              โ
โ           โผ                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโ                                         โ
โ  โ grid_system.py     โ                                         โ
โ  โ โข GridSystem       โ                                         โ
โ  โ   โโ draw_grid()                                            โ
โ  โ   โโ parse_response()                                       โ
โ  โ   โโ calculate_coords()                                     โ
โ  โโโโโโโโโโฌโโโโโโโโโโโโ                                         โ
โ           โ                                                      โ
โ           โ Imagen con Grilla                                   โ
โ           โผ                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโ                                         โ
โ  โ openai_client.py   โ                                         โ
โ  โ โข OpenAIClient     โ                                         โ
โ  โ   โโ ask_with_image()                                       โ
โ  โ       (Responses API)                                        โ
โ  โโโโโโโโโโฌโโโโโโโโโโโโ                                         โ
โ           โ                                                      โ
โ           โ Respuesta JSON                                      โ
โ           โผ                                                      โ
โ  {"found": true, "cells": [...], ...}                          โ
โ           โ                                                      โ
โ           โ Coordenadas (x, y)                                  โ
โ           โผ                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโ                                         โ
โ  โ    PyAutoGUI       โ                                         โ
โ  โ    โข click()       โ                                         โ
โ  โ    โข moveTo()      โ                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโ                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   Capa de Infraestructura                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ                  โ
โ  โ  logger.py       โ    โ  exceptions.py   โ                  โ
โ  โ  โข setup_logger()โ    โ  โข Custom        โ                  โ
โ  โ  โข log_*()       โ    โ    Exceptions    โ                  โ
โ  โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Flujo de Ejecuciรณn

### 1. Inicio de Aplicaciรณn

```
Usuario ejecuta: python3 main.py
         โ
         โผ
  Validar config.OPENAI_API_KEY
         โ
         โผ
  Mostrar banner e instrucciones
         โ
         โผ
  Solicitar instrucciรณn del usuario
```

### 2. Generaciรณn de Plan

```
Instrucciรณn: "Send email to john@test.com"
         โ
         โผ
  Planner.generate_plan()
         โ
         โโโถ OpenAIClient.generate_plan()
         โ        โ
         โ        โโโถ Chat Completions API
         โ                  โ
         โ                  โผ
         โ           Prompt con patrones
         โ                  โ
         โ                  โผ
         โ        Respuesta JSON con pasos
         โ
         โผ
  ActionPlan (validado)
  [
    {"action": "click", "target": "compose button"},
    {"action": "wait", "seconds": 1},
    {"action": "type", "text": "john@test.com"},
    ...
  ]
```

### 3. Ejecuciรณn de Plan

```
Para cada paso en el plan:
         โ
         โผ
  ยฟQuรฉ acciรณn?
         โ
    โโโโโโดโโโโโฌโโโโโโโโโฌโโโโโโโโโโ
    โ         โ        โ         โ
    โผ         โผ        โผ         โผ
  CLICK     TYPE     PRESS     WAIT
    โ         โ        โ         โ
    โ         โ        โ         โ
    โผ         โ        โ         โ
(Ver flujo)  โ        โ         โ
             โผ        โผ         โผ
        PyAutoGUI  PyAutoGUI  time.sleep()
         .write()   .press()
```

### 4. Flujo de CLICK (Detallado)

```
execute_click(target="compose button")
         โ
         โผ
  ScreenCapture.capture_screen()
         โ
         โผ
  GridSystem.draw_grid_on_image()
         โ
         โโโถ Verificar cache
         โ   (evitar redibujar)
         โ
         โผ
  Imagen con grilla numerada (0-575)
         โ
         โผ
  Crear prompt de visiรณn:
  "Find 'compose button' in grid cells..."
         โ
         โผ
  OpenAIClient.ask_with_image()
         โ
         โโโถ Responses API (GPT-4o Vision)
                  โ
                  โผ
           Analiza imagen con grilla
                  โ
                  โผ
           Retorna JSON:
           {
             "found": true,
             "cells": [
               {"cell_number": 42, "coverage_percent": 80},
               {"cell_number": 43, "coverage_percent": 20}
             ],
             "confidence": "high"
           }
         โ
         โผ
  GridSystem.calculate_coordinates_from_cells()
         โ
         โโโถ Centroide ponderado por cobertura
         โ
         โผ
  Coordenadas (x_img, y_img)
         โ
         โผ
  ScreenCapture.get_display_scale()
         โ
         โโโถ Para pantallas Retina
         โ
         โผ
  Coordenadas lรณgicas (x_log, y_log)
         โ
         โผ
  _execute_multi_click_pattern()
         โ
         โโโถ Captura pantalla ANTES
         โโโถ Click en centro
         โโโถ Captura pantalla DESPUรS
         โโโถ Detectar cambios
         โ   โ
         โ   โโโถ ยฟCambiรณ?
         โ          โ
         โ       โโโโดโโโ
         โ       โ     โ
         โ       Sรญ    No
         โ       โ     โ
         โ       โ     โโโถ Probar siguiente posiciรณn
         โ               (arriba/abajo/izq/der)
         โผ
  Retorna True/False
```

## ๐งฉ Responsabilidades de Mรณdulos

### Core

**config.py**
- โ Almacenar todas las constantes
- โ Validar variables de entorno
- โ Proveer configuraciรณn รบnica

**exceptions.py**
- โ Definir jerarquรญa de errores
- โ Mensajes descriptivos
- โ Facilitar debugging

**logger.py**
- โ Logging estructurado
- โ Niveles de log
- โ Emojis para UX

### Vision & Screen

**screen_capture.py**
- โ Capturar pantalla
- โ Manejar escalado Retina
- โ Codificar para API
- โ Detectar cambios

**grid_system.py**
- โ Dibujar grilla numerada
- โ Cachear grillas
- โ Calcular coordenadas
- โ Parsear respuestas

### AI Integration

**openai_client.py**
- โ Wrapper de OpenAI API
- โ Responses API (visiรณn)
- โ Chat Completions (planning)
- โ Manejo de errores

### Planning

**planner.py**
- โ Generar planes
- โ Validar estructura
- โ Parsear JSON
- โ Logging de planes

### Execution

**actions.py**
- โ Ejecutar acciones individuales
- โ Multi-click pattern
- โ Typing con clipboard
- โ Verificar efectos

**executor.py**
- โ Ejecutar planes completos
- โ Manejo de errores por paso
- โ Estadรญsticas
- โ Cleanup

## ๐ Principios de Diseรฑo

### 1. Separaciรณn de Concerns
Cada mรณdulo tiene una responsabilidad รบnica y bien definida.

### 2. Dependency Injection
Los mรณdulos reciben sus dependencias, facilitando testing y flexibilidad.

```python
# Ejemplo: ActionExecutor recibe dependencias
executor = ActionExecutor(
    screen_capture=my_capture,
    grid_system=my_grid,
    openai_client=my_client
)
```

### 3. Fail Fast
Validaciones tempranas para detectar errores rรกpidamente.

```python
# Config.validate() al inicio
# ActionPlan valida en constructor
```

### 4. Single Responsibility
Una funciรณn, un propรณsito.

```python
# โ Malo
def capture_and_analyze():
    # Hace dos cosas

# โ Bueno
def capture_screen():
    # Solo captura

def analyze_image():
    # Solo analiza
```

### 5. Open/Closed
Abierto para extensiรณn, cerrado para modificaciรณn.

```python
# Agregar nueva acciรณn sin modificar cรณdigo existente
# Solo agregar mรฉtodo en ActionExecutor
```

## ๐ Mรฉtricas de Cรณdigo

### Complejidad por Mรณdulo

| Mรณdulo | Lรญneas | Complejidad | Responsabilidad |
|--------|--------|-------------|-----------------|
| config.py | 73 | Baja | Configuraciรณn |
| exceptions.py | 65 | Baja | Excepciones |
| logger.py | 135 | Media | Logging |
| screen_capture.py | 170 | Media | Captura |
| grid_system.py | 263 | Alta | Grilla |
| openai_client.py | 164 | Media | API |
| planner.py | 164 | Media | Planificaciรณn |
| actions.py | 330 | Alta | Ejecuciรณn |
| executor.py | 150 | Media | Orquestaciรณn |
| main.py | 120 | Baja | Entry point |

### Acoplamiento

```
main.py
  โโ config (bajo)
  โโ logger (bajo)
  โโ Planner (medio)
  โโ PlanExecutor (medio)

Planner
  โโ OpenAIClient (bajo)

PlanExecutor
  โโ ActionExecutor (medio)

ActionExecutor
  โโ ScreenCapture (medio)
  โโ GridSystem (medio)
  โโ OpenAIClient (medio)
```

### Cohesiรณn

- **Alta cohesiรณn** en todos los mรณdulos
- Funciones relacionadas agrupadas
- Responsabilidades claras

## ๐ Extensibilidad

### Agregar Nueva Funcionalidad

1. **Nueva acciรณn**: Modificar `planner.py`, `actions.py`, `executor.py`
2. **Nuevo modelo AI**: Modificar `openai_client.py`, `config.py`
3. **Nueva validaciรณn**: Modificar `planner.py`
4. **Nuevo tipo de captura**: Extender `screen_capture.py`

### Puntos de Extensiรณn

- โ Acciones personalizadas
- โ Validadores de plan
- โ Estrategias de click
- โ Backends de logging
- โ Proveedores de AI

## ๐งช Testabilidad

Todos los mรณdulos son fรกcilmente testables gracias a:

1. **Dependency Injection**
2. **Interfaces claras**
3. **Sin estado global** (excepto config)
4. **Excepciones especรญficas**

```python
# Ejemplo: Mockeando OpenAI en tests
class MockOpenAIClient:
    def ask_with_image(self, prompt, image):
        return '{"found": true, "cells": [...]}'

# Inyectar en tests
executor = ActionExecutor(
    openai_client=MockOpenAIClient()
)
```

## ๐ Escalabilidad

La arquitectura permite:

- โ Procesamiento paralelo (futuro)
- โ Mรบltiples backends de AI
- โ Caching a diferentes niveles
- โ Distribuciรณn de carga
- โ Plugins y extensiones

---

Esta arquitectura proporciona una base sรณlida, mantenible y extensible para UnifyVision.
